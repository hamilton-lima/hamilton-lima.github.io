<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Avoid insanity when handling errors with Chai - Hamilton Lima</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://hamiltonlima.comfavicon.png><link rel=canonical href=https://hamiltonlima.com/posts/avoid-insanity-when-handling-errors-with-chai/><link rel=stylesheet href=/css/style.min.381fd69187be1f5dde5031ac9014016e77965dbc38358cb065b6fede27b5861c.css><link rel=stylesheet href=/assets/css/extended.min.9729f28a5087b689b946e103d96abd63bfd37b1417effa251dbf798312e3fba5.css><meta property="og:title" content="Avoid insanity when handling errors with Chai"><meta property="og:type" content="website"><meta property="og:url" content="https://hamiltonlima.com/posts/avoid-insanity-when-handling-errors-with-chai/"><meta name=twitter:card content="summary"><meta name=twitter:site content="@athanazio"><meta name=twitter:creator content="@athanazio"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class="page frame page-blog-single"><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-posts><a href=https://hamiltonlima.com/posts>Posts</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>Hamilton Lima</a><div class=menu-main><ul><li class=menu-item-posts><a href=/posts><span>Posts</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>Avoid insanity when handling errors with Chai<span class=dot>.</span></h1></div><div class=content><p><img src=/images/2021/insanity.png alt="Vaas from Farcry3">
If you ever played Farcry3 for sure you will remember the guy in the picture, if you never hear about him, Take a look on this video, <a href="https://www.youtube.com/watch?v=itjmKlYjUak">The definition of insanity - Far Cry 3</a>.</p><p>While coding some unit tests for the <a href=https://github.com/hamilton-lima/smallflatworld>SmallFlatWorld</a> server, I got myself in a very interesting situation, where my old Java memories guided me to implement a test in a specific way, while some documentation was pointing in another direction&mldr; Well Vaas has a point, repeating the same thing over and over and expecting the same results it&rsquo;s kinda insane. Then I try multiple ways to do the same thing, let&rsquo;s take a look.</p><h3 id=what-is-this-test-about>What is this test about?</h3><ul><li>Verify if a specific scenario will throw an exception</li><li>Make a simple and readable test</li><li>Write test that I can understand without a need for searching about it</li><li>Minimize brainpower need to decypher the test so I can change without fear</li></ul><h2 id=what-are-the-options-i-tried>What are the options I tried</h2><h3 id=the-magician-bind>The magician bind!</h3><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>expect(this.storage.getStorage.bind(this.storage, &#34;foo&#34;)).to.throw(
  &#34;uuid dont exist in memory&#34;
);
</code></pre></div><p>If you look at the documentation you will find that <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind>bind</a> will create a new function, with the <code>this</code> reference you passed as argument, plus other arguments you give to it.</p><p>In other words, a function in this case <code>getStorage</code> can be recycled to be used in other instance, so other <code>this</code> reference and be called by the <code>expect</code> function and then we can check for the the error using <code>to.throw</code>.</p><p>As I don&rsquo;t <code>bind</code> most of the time, this solution seems very fuzzy, it works but I would need a quick read to recap, and answer my expected reaction to this code in couple months: &ldquo;Why on earth am I using <code>bind</code> here?&rdquo;</p><h3 id=anonymous-functions-ftw>Anonymous functions FTW!</h3><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>const self = this;
expect(function () {
  self.storage.getStorage(&#34;foo&#34;);
}).to.throw(&#34;uuid dont exist in memory&#34;);

expect(() =&gt; {
  this.storage.getStorage(&#34;foo&#34;);
}).to.throw(&#34;uuid dont exist in memory&#34;);
</code></pre></div><p>Both solutions here rely on creating an anonymous function, and letting <code>expect</code> to execute them.</p><p>But there is a gotcha, there is always a gotcha, when you create a function using <code>function ()</code> syntax, and you code is running on stric mode, that function <code>this</code> will be <code>undefined</code>! for this reason you can see a not so cool workaround, as know as patch and for me a fine example of <a href=https://gist.github.com/banaslee/4147370>Go horse programming</a>, the <code>const self = this</code>. that provides the existing <code>this</code> reference to the function.</p><p>The second version, using the arrow syntax, as defined here <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions>Arrow functions</a> does NOT have it&rsquo;s own <code>this</code> reference, so it will rely on the existing one, and that would work just fine.</p><p>Sending functions as parameters sometimes feels like blackmagic, I know how it works but requires some brainpower to process it, and for me tests should not be a place to exercise theses powers.</p><p><img src=/images/2021/you-have-no-power-here.jpg alt="Brain you have no power here"></p><h3 id=the-verbose-but-clear>The verbose, but clear</h3><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>try {
  this.storage.getStorage(&#34;foo&#34;);
} catch (error) {
  expect(error.message).to.be.equal(&#34;uuid dont exist in memory&#34;);
}
</code></pre></div><p>This is the verbose version, but very clear what is going on, the code starts with <code>try {</code>, even if you don&rsquo;t know the language, or if you are very tired, or watching a video while reading the code, you will be able to understand that something is expected to go wrong in the next lines.</p><p>The piece of code that is under test is called the same way it will be used in other parts of the code, so again no magic here, no mental transformation, no extra variables to hunt you with the question, will this impact the test? just a function call <code>this.storage.getStorage("foo");</code></p><p>Then at the end a <code>catch</code> with a <code>expect</code> in it, saying out loud: &ldquo;This test expects the code above to fail, and to fail with this message&rdquo;.</p><p>For me this is the winner :)</p><h3 id=references>References</h3><ul><li><a href=https://www.chaijs.com/api/bdd/#method_throw>Chai to.throw</a></li><li><a href=https://github.com/hamilton-lima/smallflatworld/blob/8f57584dc6f5e3b8c2326ffb4f866ce110abc976/server/tests/memory.storage.spec.ts#L22>smallflatworld test code reference</a></li></ul></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-twitter"><a href=https://twitter.com/athanazio title=twitter target=_blank rel=noopener><img src=/images/icons/twitter.svg width=24 height=24 alt=twitter></a></span>
<span class="social-icon social-icon-github"><a href=https://github.com/hamilton-lima title=github target=_blank rel=noopener><img src=/images/icons/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/hamiltonlima title=linkedin target=_blank rel=noopener><img src=/images/icons/linkedin.svg width=24 height=24 alt=linkedin></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.df8701b5f509374aa1fd6b7f39e6100d9eedbb268d023d3bec1a6e8220fd6dee.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-J7T3DC7D47"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-J7T3DC7D47');</script></body></html>