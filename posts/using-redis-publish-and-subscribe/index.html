<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#ffb703"><meta name=msapplication-TileColor content="#ffb703"><meta itemprop=name content="Using Redis Publish and Subscribe"><meta itemprop=description content="There is this game called Robolucha where you code your robots to fight in a virtual arena. I&rsquo;ve been working on this project for some years and last year decided to rewrite everything, mainly for the sake of technical exploration and this post share challenges using Redis Publish and subscribe.
Proving the concept Before I start to hit the keyboard to refactor MatchStatePublisher to send match states to Redis, I had some homework to do."><meta itemprop=datePublished content="2018-05-11T01:01:24+00:00"><meta itemprop=dateModified content="2018-05-11T01:01:24+00:00"><meta itemprop=wordCount content="789"><meta itemprop=keywords content="java,junit,publisher,pubsub,redis,robolucha,subscriber,"><meta property="og:title" content="Using Redis Publish and Subscribe"><meta property="og:description" content="There is this game called Robolucha where you code your robots to fight in a virtual arena. I&rsquo;ve been working on this project for some years and last year decided to rewrite everything, mainly for the sake of technical exploration and this post share challenges using Redis Publish and subscribe.
Proving the concept Before I start to hit the keyboard to refactor MatchStatePublisher to send match states to Redis, I had some homework to do."><meta property="og:type" content="article"><meta property="og:url" content="http://hamiltonlima.com/posts/using-redis-publish-and-subscribe/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-11T01:01:24+00:00"><meta property="article:modified_time" content="2018-05-11T01:01:24+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Redis Publish and Subscribe"><meta name=twitter:description content="There is this game called Robolucha where you code your robots to fight in a virtual arena. I&rsquo;ve been working on this project for some years and last year decided to rewrite everything, mainly for the sake of technical exploration and this post share challenges using Redis Publish and subscribe.
Proving the concept Before I start to hit the keyboard to refactor MatchStatePublisher to send match states to Redis, I had some homework to do."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Using Redis Publish and Subscribe</title><link rel=stylesheet href=http://hamiltonlima.com/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=http://hamiltonlima.com>Hamilton Lima</a></div><nav class="site-nav hide-in-mobile"><a href=http://hamiltonlima.com/posts>Posts</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/athanazio target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/hamilton-lima target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=http://hamiltonlima.com/posts>Posts</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>May 11, 2018</span></div><h1>Using Redis Publish and Subscribe</h1></header><div class=content><p>There is this game called Robolucha where you code your robots to fight in a virtual arena. I&rsquo;ve been working on this project for some years and last year decided to rewrite everything, mainly for the sake of technical exploration and this post share challenges using Redis Publish and subscribe.</p><h2 id=proving-the-concept>Proving the concept<a href=#proving-the-concept class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Before I start to hit the keyboard to refactor MatchStatePublisher to send match states to Redis, I had some homework to do. So I build a POC (Proof of concept) to understand how <a href=https://github.com/xetorthio/jedis>Jedis</a> client works and is possible to do with it. The first discovery is that you can&rsquo;t use the same connection for publishing AND subscribing, you need to separate JedisPool or even a Jedis connection if there is no pool. The POC has two separated apps one to publish data and another to subscribe to the changes, the code can be found <a href=https://github.com/hamilton-lima/robolucha/tree/master/pocs/redis/java-pubsub>here</a></p><h2 id=how-to-test-it>How to test it<a href=#how-to-test-it class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>1. start the Redis server using the default <a href=https://hub.docker.com/_/redis/>Redis docker image</a></p><pre><code>docker run --name test-redis --rm -p 6379:6379 -d redis
</code></pre><p>2. run the Subscriber class 3. run the Publisher class that will start 10 threads to send 5000 messages each The subscriber screen should display every single message received.</p><h2 id=using-the-lessons-in-the-runner-application>Using the lessons in the runner application<a href=#using-the-lessons-in-the-runner-application class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>After the POC establish the foundations for the implementation I add some extra requirements:</p><ul><li>The queue names should be auto-generated based on the class name</li><li>Observables from <a href=https://github.com/ReactiveX/RxJava>RxJava</a> should be used to implement the subscription</li><li>The subscription process should not block the current Thread</li><li>The queue message parsing from and to objects should be transparent</li><li>Publishing should accept <a href=https://en.wikipedia.org/wiki/Plain_old_Java_object>POJO</a> as parameters</li><li>The entire publish and subscribe process should be testable</li></ul><p>I can say that all the requirements were fulfilled. Some with more challenges than others :) Let&rsquo;s go over the details of each one.</p><h2 id=queue-names-generation-observables-and-asynchronous-subscription>Queue names generation, Observables, and asynchronous subscription<a href=#queue-names-generation-observables-and-asynchronous-subscription class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>The method that generates the queue name is very straightforward</p><pre><code>private String getChannelName(Class clazz) {
    return clazz.getCanonicalName();
}
</code></pre><p>So when using subscribe or publish the queue names would be something like com.robolucha.models.Luchador For the use of Observables, the method subscribes returns a <a href=http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/subjects/BehaviorSubject.html>BehaviorSubject</a> of whatever class is sent as a parameter for the subscription.</p><pre><code>public &lt;T&gt; BehaviorSubject subscribe(Class&lt;T&gt; clazzToSubscribe) {
    BehaviorSubject&lt;T&gt; result = BehaviorSubject.create();
    ...
    return result;
}
</code></pre><p><a href=https://github.com/xetorthio/jedis>Jedis</a> client is implementation blocks the current thread when the subscription happens, to workaround that there is a separated Thread to subscribe and an additional listener to interrupt this thread the BehaviorSubject completes.</p><pre><code>Thread subscriber = new Thread(new Runnable() {
    public void run() {
        Jedis subscriber = subscriberPool.getResource();
        subscriber.subscribe(new JedisPubSub() {
        ...
        }, channel);
        subscriber.close();
    }
});

result.subscribe(new ThreadKiller&lt;&gt;(subscriber));
subscriber.start();
</code></pre><h2 id=transparent-parsing-pojo>Transparent parsing, POJO<a href=#transparent-parsing-pojo class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>When publishing the object is converted to JSON and when receiving the message the JSON string is converted to the expected object type as well. making the process transparent for the consumer of the RemoteQueue implementation.</p><pre><code>public void onMessage(String channel, String message) { (1)
    T data = gson.fromJson(message, clazzToSubscribe); (2)
    result.onNext(data); (3)
}
</code></pre><p>(1) happens when the subscription receives a message from the queue (2) convert the JSON to the object type defined by clazzToSubscribe (3) push the received value to the BehaviourSubject stream</p><h2 id=unit-testing-er-end-to-end-testing>Unit testing&mldr; er&mldr; End to End testing<a href=#unit-testing-er-end-to-end-testing class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>The initial expectation was to build a unit test, but the final implementation is actually and End2End, and actually, a Redis server is used in the test. To have the Redis server running for the test the class <a href=https://github.com/hamilton-lima/robolucha/blob/master/src/runner/src-test/com/robolucha/publisher/RedisDockerHelper.java>RedisDockerHelper</a> was created to wrap the docker commands to start and stop a Redis server, meaning that in the test the usage is only .start() and .stop(), see class <a href=https://github.com/hamilton-lima/robolucha/blob/master/src/runner/src-test/com/robolucha/publisher/RedisDockerHelper.java>RedisDockerHelper</a> that run the docker commands and logs the console outputs. Here are some fragments from the test</p><pre><code>try (RemoteQueue queue = new RemoteQueue(Config.getInstance())) {
</code></pre><p>Execute the code using <a href=https://github.com/hamilton-lima/robolucha/blob/master/src/runner/src/com/robolucha/publisher/RemoteQueue.java>the RemoteQueue</a> instance as an <a href=https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html>AutoCloseable</a> so when the block finishes the close() the method from the object will be called releasing the <a href=https://github.com/xetorthio/jedis>Jedis</a> pools from memory.</p><pre><code>assertEquals(&quot;subscribe&quot;, future.get(5, TimeUnit.SECONDS));
</code></pre><p>This assertion will wait for the future object (<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html>CompletableFuture</a>) to be fulfilled or for the timeout of 5 seconds, whatever comes first. This is an elegant way to keep the unit test waiting for the pub and subprocess to end. Note that inside the accept method the future is fulfilled with the command future.complete(&ldquo;subscribe&rdquo;); See the complete test here:Â <a href=https://github.com/hamilton-lima/robolucha/blob/master/src/runner/src-test/com/robolucha/publisher/RemoteQueueTest.java>RemoteQueueTest</a></p><h2 id=complete-aka-last-words>.complete() a.k.a. last words<a href=#complete-aka-last-words class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>There were lots of interesting challenges in this implementation, but for me, the most interesting one was the use of generics with Observables for the subscription process, It&rsquo;s nice to see fragments like this:</p><pre><code>public &lt;T&gt; BehaviorSubject subscribe(Class&lt;T&gt; clazzToSubscribe) {
BehaviorSubject&lt;T&gt; result = BehaviorSubject.create();
</code></pre><p>Of course, there are other ways to implement this without RxJava, or any other library, but it looks really good with the Observables.</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=http://hamiltonlima.com/tags/java>java</a></span><span class=tag><a href=http://hamiltonlima.com/tags/junit>junit</a></span><span class=tag><a href=http://hamiltonlima.com/tags/publisher>publisher</a></span><span class=tag><a href=http://hamiltonlima.com/tags/pubsub>pubsub</a></span><span class=tag><a href=http://hamiltonlima.com/tags/redis>redis</a></span><span class=tag><a href=http://hamiltonlima.com/tags/robolucha>robolucha</a></span><span class=tag><a href=http://hamiltonlima.com/tags/subscriber>subscriber</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>789 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2018-05-11 01:01 +0000</p></footer></article><div class="post-nav thin"><a class=next-post href=http://hamiltonlima.com/posts/image-processing-with-ionic/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>Image Processing with Ionic</span></a>
<a class=prev-post href=http://hamiltonlima.com/posts/virtualbox-with-static-and-dynamic-ip/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Virtualbox with static and dynamic IP</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=http://hamiltonlima.com>Hamilton Lima</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=http://hamiltonlima.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=http://hamiltonlima.com/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>