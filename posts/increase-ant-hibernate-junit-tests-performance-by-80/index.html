<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=theme-color content="#ffb703">
<meta name=msapplication-TileColor content="#ffb703">
<meta itemprop=name content="Increase Ant Hibernate Junit tests Performance by 80%">
<meta itemprop=description content="If don´t want to read everything, just set forkingmode=&ldquo;once&rdquo; to have huge improvement in your tests processing time. :)
Now the details&mldr; I have several, around 100 junit tests in Robolucha project, most of then use Hibernate and are run by an ant script. When you start Java Virtual machine Hibernate prepares itself to connect to the database by checking the necessary tables and preparing all the internals needed to work, but this process takes some time, some seconds to say the true."><meta itemprop=datePublished content="2016-12-27T20:52:25+00:00">
<meta itemprop=dateModified content="2016-12-27T20:52:25+00:00">
<meta itemprop=wordCount content="518">
<meta itemprop=keywords content="ant,hibernate,junit,mysql,performance,robolucha,selfhackaton,"><meta property="og:title" content="Increase Ant Hibernate Junit tests Performance by 80%">
<meta property="og:description" content="If don´t want to read everything, just set forkingmode=&ldquo;once&rdquo; to have huge improvement in your tests processing time. :)
Now the details&mldr; I have several, around 100 junit tests in Robolucha project, most of then use Hibernate and are run by an ant script. When you start Java Virtual machine Hibernate prepares itself to connect to the database by checking the necessary tables and preparing all the internals needed to work, but this process takes some time, some seconds to say the true.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://hamiltonlima.com/posts/increase-ant-hibernate-junit-tests-performance-by-80/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-12-27T20:52:25+00:00">
<meta property="article:modified_time" content="2016-12-27T20:52:25+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Increase Ant Hibernate Junit tests Performance by 80%">
<meta name=twitter:description content="If don´t want to read everything, just set forkingmode=&ldquo;once&rdquo; to have huge improvement in your tests processing time. :)
Now the details&mldr; I have several, around 100 junit tests in Robolucha project, most of then use Hibernate and are run by an ant script. When you start Java Virtual machine Hibernate prepares itself to connect to the database by checking the necessary tables and preparing all the internals needed to work, but this process takes some time, some seconds to say the true.">
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=/favicon.ico>
<title>Increase Ant Hibernate Junit tests Performance by 80%</title>
<link rel=stylesheet href=https://hamiltonlima.com/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous>
</head>
<body id=page>
<header id=site-header class="animated slideInUp">
<div class="hdr-wrapper section-inner">
<div class=hdr-left>
<div class=site-branding>
<a href=https://hamiltonlima.com>Hamilton Lima</a>
</div>
<nav class="site-nav hide-in-mobile">
<a href=https://hamiltonlima.com/posts>Posts</a>
</nav>
</div>
<div class="hdr-right hdr-icons">
<span class="hdr-social hide-in-mobile"><a href=https://twitter.com/athanazio target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/hamilton-lima target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
</div>
</div>
</header>
<div id=mobile-menu class="animated fast">
<ul>
<li><a href=https://hamiltonlima.com/posts>Posts</a></li>
</ul>
</div>
<main class="site-main section-inner animated fadeIn faster">
<article class=thin>
<header class=post-header>
<div class=post-meta><span>Dec 27, 2016</span></div>
<h1>Increase Ant Hibernate Junit tests Performance by 80%</h1>
</header>
<div class=content>
<p><img src=/images/2016/12/performance_comparision_junit_ant_hibernate.png alt> If don´t want to read everything, just set <strong>forkingmode=&ldquo;once&rdquo;</strong> to have huge improvement in your tests processing time. :)</p>
<h3 id=now-the-details>Now the details&mldr;<a href=#now-the-details class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3>
<p>I have several, around 100 junit tests in <a href=http://www.robolucha.com/>Robolucha</a> project, most of then use <a href=http://hibernate.org/orm/>Hibernate</a> and are run by an ant script. When you start Java Virtual machine Hibernate prepares itself to connect to the database by checking the necessary tables and preparing all the internals needed to work, but this process takes some time, some seconds to say the true. When you are running the unit tests and forking each process in a separated VM by using fork=&ldquo;yes&rdquo; the default behavior is to run one VM per test. With one VM per test, the result would be Hibernate running preparing its internals for each test, and the results are around 5 minutes as you can see at the table above. So reuse the Hibernate preparation was the main goal of the optimization but some other options were explored and some nice findings came from that. Here are the steps I did trying to optimize the test performance:</p>
<ul>
<li>Reuse Hibernate preparation</li>
<li>Use in Memory tables</li>
<li>Use MyISAM tables</li>
<li>Set hbm2ddl to none - no significant results from this one</li>
</ul>
<h3 id=reuse-hibernate-preparation>Reuse Hibernate preparation<a href=#reuse-hibernate-preparation class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3>
<p>As you can see at <a href=https://ant.apache.org/manual/Tasks/junit.html>junit ant task documentation</a>, the default behavior for fork=yes is to set forkmode=&ldquo;perTest&rdquo;, and that was the main reason for the poor performance on my tests. set forkmode=&ldquo;once&rdquo; and only one VM will be created to the tests and Hibernate preparation will run only once, changing the times from around 5 minutes to one.</p>
<h3 id=use-different-types-of-tables>Use different types of tables<a href=#use-different-types-of-tables class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3>
<p>InnoDB offers several nice features like referential integrity and so on, by there are other options with less features and much better performance, for the tests I tried to use then to check the performance, but it wasn´t that easy :) First I tried myISAM table tyble just changed the hibernate.dialect to <a href=http://grepcode.com/file/repo1.maven.org/maven2/org.hibernate/hibernate-core/4.3.6.Final/org/hibernate/dialect/MySQLMyISAMDialect.java#MySQLMyISAMDialect>org.hibernate.dialect.MySQLMyISAMDialect</a>, but sadly this class is using a wrong parameter at the method <a href=http://grepcode.com/file/repo1.maven.org/maven2/org.hibernate/hibernate-core/4.3.6.Final/org/hibernate/dialect/Dialect.java#Dialect.getTableTypeString%28%29 title="Overrides org.hibernate.dialect.Dialect.getTableTypeString()">getTableTypeString</a>(), its returning <strong>type=MyISAM</strong> where it should be: <strong>ENGINE=MyISAM</strong>, So in order to fix it I extended MySQL5InnoDBDialect by overriding getTableTypeString()</p>
<pre><code>public class **MySQL5MyISAMDBDialectEngine** extends MySQL5InnoDBDialect {

  public MySQL5MyISAMDBDialectEngine() {
    super();
  }

  @Override
  public String getTableTypeString() {
    return &quot; ENGINE=MyISAM&quot;;
  }
}
</code></pre><p>Used a similar strategy for the in memory tables, with an extra detail that in <a href=http://dev.mysql.com/doc/refman/5.7/en/memory-storage-engine.html>Memory table DON´T support BLOB types</a>, so I need to create a custom mapping for large strings to use VARCHAR(1024) instead of BLOB.</p>
<pre><code>public class **MySQL5InnoDBDialectInMemory** extends MySQL5InnoDBDialect {

  public MySQL5InnoDBDialectInMemory() {
    super();
  }

  @Override
  public String getTableTypeString() {
    return &quot; ENGINE=MEMORY&quot;;
  }

 /\*\*
  \* avoid LONGTEXT that are not supported by In Memory tables
  \*/
  @Override
  protected void registerVarcharTypes() {
    registerColumnType(Types.VARCHAR, &quot;varchar(1024)&quot;);
    registerColumnType(Types.VARCHAR, 255, &quot;varchar($l)&quot;);
    registerColumnType(Types.LONGVARCHAR, &quot;varchar(1024)&quot;);
  }
}
</code></pre><h3 id=conclusion>Conclusion<a href=#conclusion class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3>
<p>After all the tests my final configuration is:</p>
<ul>
<li>junit fork=&ldquo;yes&rdquo; forkmode=&ldquo;once&rdquo;</li>
<li>hbm2ddl=update</li>
<li>hibernate.dialect=com.robolucha.test.MySQL5MyISAMDBDialectEngine</li>
</ul>
<p>Forcing the use of only one VM for all the tests, checking if all the necessary tables are in place, as this dont take that much time and using myISAM tables that has almost the same performance as in Memory but uses less memory.</p>
</div>
<hr class=post-end>
<footer class=post-info>
<p>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://hamiltonlima.com/tags/ant>ant</a></span><span class=tag><a href=https://hamiltonlima.com/tags/hibernate>hibernate</a></span><span class=tag><a href=https://hamiltonlima.com/tags/junit>junit</a></span><span class=tag><a href=https://hamiltonlima.com/tags/mysql>mysql</a></span><span class=tag><a href=https://hamiltonlima.com/tags/performance>performance</a></span><span class=tag><a href=https://hamiltonlima.com/tags/robolucha>robolucha</a></span><span class=tag><a href=https://hamiltonlima.com/tags/selfhackaton>selfhackaton</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>518 Words</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2016-12-27 20:52 +0000</p>
</footer>
</article>
<div class="post-nav thin">
<a class=next-post href=https://hamiltonlima.com/posts/beepify-io-source-code-available/>
<span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>beepify.io source code available</span>
</a>
<a class=prev-post href=https://hamiltonlima.com/posts/holidays-selfhackaton-the-start/>
<span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Holidays selfhackaton - the start</span>
</a>
</div>
<div id=comments class=thin>
</div>
</main>
<footer id=site-footer class="section-inner thin animated fadeIn faster">
<p>&copy; 2021 <a href=https://hamiltonlima.com>Hamilton Lima</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p>
<p>
Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://hamiltonlima.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a>
</p>
</footer>
<script src=https://hamiltonlima.com/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script>
</body>
</html>