<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Increase Ant Hibernate Junit tests Performance by 80% - Hamilton Lima</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://hamiltonlima.comfavicon.png><link rel=canonical href=https://hamiltonlima.com/posts/increase-ant-hibernate-junit-tests-performance-by-80/><link rel=stylesheet href=/css/style.min.381fd69187be1f5dde5031ac9014016e77965dbc38358cb065b6fede27b5861c.css><link rel=stylesheet href=/assets/css/extended.min.9729f28a5087b689b946e103d96abd63bfd37b1417effa251dbf798312e3fba5.css><meta property="og:title" content="Increase Ant Hibernate Junit tests Performance by 80%"><meta property="og:type" content="website"><meta property="og:url" content="https://hamiltonlima.com/posts/increase-ant-hibernate-junit-tests-performance-by-80/"><meta name=twitter:card content="summary"><meta name=twitter:site content="@athanazio"><meta name=twitter:creator content="@athanazio"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class="page frame page-blog-single"><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-posts><a href=https://hamiltonlima.com/posts>Posts</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>Hamilton Lima</a><div class=menu-main><ul><li class=menu-item-posts><a href=/posts><span>Posts</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>Increase Ant Hibernate Junit tests Performance by 80%<span class=dot>.</span></h1></div><div class=content><p><img src=/images/2016/12/performance_comparision_junit_ant_hibernate.png alt> If don´t want to read everything, just set <strong>forkingmode="once&rdquo;</strong> to have huge improvement in your tests processing time. :)</p><h3 id=now-the-details>Now the details&mldr;</h3><p>I have several, around 100 junit tests in <a href=http://www.robolucha.com/>Robolucha</a> project, most of then use <a href=http://hibernate.org/orm/>Hibernate</a> and are run by an ant script. When you start Java Virtual machine Hibernate prepares itself to connect to the database by checking the necessary tables and preparing all the internals needed to work, but this process takes some time, some seconds to say the true. When you are running the unit tests and forking each process in a separated VM by using fork="yes&rdquo; the default behavior is to run one VM per test. With one VM per test, the result would be Hibernate running preparing its internals for each test, and the results are around 5 minutes as you can see at the table above. So reuse the Hibernate preparation was the main goal of the optimization but some other options were explored and some nice findings came from that. Here are the steps I did trying to optimize the test performance:</p><ul><li>Reuse Hibernate preparation</li><li>Use in Memory tables</li><li>Use MyISAM tables</li><li>Set hbm2ddl to none - no significant results from this one</li></ul><h3 id=reuse-hibernate-preparation>Reuse Hibernate preparation</h3><p>As you can see at <a href=https://ant.apache.org/manual/Tasks/junit.html>junit ant task documentation</a>, the default behavior for fork=yes is to set forkmode="perTest&rdquo;, and that was the main reason for the poor performance on my tests. set forkmode="once&rdquo; and only one VM will be created to the tests and Hibernate preparation will run only once, changing the times from around 5 minutes to one.</p><h3 id=use-different-types-of-tables>Use different types of tables</h3><p>InnoDB offers several nice features like referential integrity and so on, by there are other options with less features and much better performance, for the tests I tried to use then to check the performance, but it wasn´t that easy :) First I tried myISAM table tyble just changed the hibernate.dialect to <a href=http://grepcode.com/file/repo1.maven.org/maven2/org.hibernate/hibernate-core/4.3.6.Final/org/hibernate/dialect/MySQLMyISAMDialect.java#MySQLMyISAMDialect>org.hibernate.dialect.MySQLMyISAMDialect</a>, but sadly this class is using a wrong parameter at the method <a href=http://grepcode.com/file/repo1.maven.org/maven2/org.hibernate/hibernate-core/4.3.6.Final/org/hibernate/dialect/Dialect.java#Dialect.getTableTypeString%28%29 title="Overrides org.hibernate.dialect.Dialect.getTableTypeString()">getTableTypeString</a>(), its returning <strong>type=MyISAM</strong> where it should be: <strong>ENGINE=MyISAM</strong>, So in order to fix it I extended MySQL5InnoDBDialect by overriding getTableTypeString()</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>public class **MySQL5MyISAMDBDialectEngine** extends MySQL5InnoDBDialect {

  public MySQL5MyISAMDBDialectEngine() {
    super();
  }

  @Override
  public String getTableTypeString() {
    return &#34; ENGINE=MyISAM&#34;;
  }
}
</code></pre></div><p>Used a similar strategy for the in memory tables, with an extra detail that in <a href=http://dev.mysql.com/doc/refman/5.7/en/memory-storage-engine.html>Memory table DON´T support BLOB types</a>, so I need to create a custom mapping for large strings to use VARCHAR(1024) instead of BLOB.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>public class **MySQL5InnoDBDialectInMemory** extends MySQL5InnoDBDialect {

  public MySQL5InnoDBDialectInMemory() {
    super();
  }

  @Override
  public String getTableTypeString() {
    return &#34; ENGINE=MEMORY&#34;;
  }

 /\*\*
  \* avoid LONGTEXT that are not supported by In Memory tables
  \*/
  @Override
  protected void registerVarcharTypes() {
    registerColumnType(Types.VARCHAR, &#34;varchar(1024)&#34;);
    registerColumnType(Types.VARCHAR, 255, &#34;varchar($l)&#34;);
    registerColumnType(Types.LONGVARCHAR, &#34;varchar(1024)&#34;);
  }
}
</code></pre></div><h3 id=conclusion>Conclusion</h3><p>After all the tests my final configuration is:</p><ul><li>junit fork="yes&rdquo; forkmode="once&rdquo;</li><li>hbm2ddl=update</li><li>hibernate.dialect=com.robolucha.test.MySQL5MyISAMDBDialectEngine</li></ul><p>Forcing the use of only one VM for all the tests, checking if all the necessary tables are in place, as this dont take that much time and using myISAM tables that has almost the same performance as in Memory but uses less memory.</p></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-twitter"><a href=https://twitter.com/athanazio title=twitter target=_blank rel=noopener><img src=/images/icons/twitter.svg width=24 height=24 alt=twitter></a></span>
<span class="social-icon social-icon-github"><a href=https://github.com/hamilton-lima title=github target=_blank rel=noopener><img src=/images/icons/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/hamiltonlima title=linkedin target=_blank rel=noopener><img src=/images/icons/linkedin.svg width=24 height=24 alt=linkedin></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.df8701b5f509374aa1fd6b7f39e6100d9eedbb268d023d3bec1a6e8220fd6dee.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-CFNGHJCTX3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-CFNGHJCTX3');</script></body></html>