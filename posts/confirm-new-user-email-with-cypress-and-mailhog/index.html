<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Confirm new user email with Cypress and MailHog - Hamilton Lima</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://hamiltonlima.comfavicon.png><link rel=canonical href=https://hamiltonlima.com/posts/confirm-new-user-email-with-cypress-and-mailhog/><link rel=stylesheet href=/css/style.min.381fd69187be1f5dde5031ac9014016e77965dbc38358cb065b6fede27b5861c.css><link rel=stylesheet href=/assets/css/extended.min.9729f28a5087b689b946e103d96abd63bfd37b1417effa251dbf798312e3fba5.css><meta property="og:title" content="Confirm new user email with Cypress and MailHog"><meta property="og:type" content="website"><meta property="og:url" content="https://hamiltonlima.com/posts/confirm-new-user-email-with-cypress-and-mailhog/"><meta name=twitter:card content="summary"><meta name=twitter:site content="@athanazio"><meta name=twitter:creator content="@athanazio"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class="page frame page-blog-single"><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-posts><a href=https://hamiltonlima.com/posts>Posts</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>Hamilton Lima</a><div class=menu-main><ul><li class=menu-item-posts><a href=/posts><span>Posts</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>Confirm new user email with Cypress and MailHog<span class=dot>.</span></h1></div><div class=content><p>I really like <a href=https://cypress.io>Cypress</a>, The tool is interactive, very developer friendly even if you don&rsquo;t plan to have a fully automated test suite, it really can save time automating tasks like, fill some forms, repeat some tasks, reproduce bugs, create new users&mldr; create new USERS&mldr; oh wait CREATE NEW USERS, how on earth I will validate the user email?</p><p><img src=/images/2022/user-creation-automation-steps-cypress.jpg alt="Gru showing steps of user creation with cypress"></p><h2 id=so-many-options>So many options</h2><p>There are some posssibilities</p><ul><li>Pay some email API services, oh GMAIL why you don&rsquo;t have it?</li><li>Navigate to mailinator webpage, parse the HTML and find the email, I need internet for this.</li><li>Pay mailinator API, did that in the past, works just fine, but you know&mldr; money.</li></ul><p>Then some revelation come, not really just research on options, why not use a local email server then build an API to get the email contents? The first one that came to mind is <a href=https://james.apache.org/>James</a> very stable email server, save data in the database, so it would be super easy to extract the messages, but why not an existing solution that is email server AND already have the API?</p><p>Then I found <a href=https://github.com/mailhog/MailHog>MAILHOG</a>! Email server with API to fetch the data, oh this is good, very good :)</p><h2 id=how-it-works>How it works?</h2><p>So let&rsquo;s see the entire process, with some quick notes</p><ul><li>Start email server, docker-compose is your friend, this is the image: <code>mailhog/mailhog:v1.0.1</code> and these are the ports: 1025 and 8025</li><li>we delete all messages from the local email server, call DELETE using <code>/api/v1/messages</code></li><li>visit the user creation page, <code>cy.visit()</code></li><li>enter the data for the new user, generate some fake date with <code>@faker-js/faker</code> then use multiple <code>cy.get().type()</code></li><li>submit the form, <code>cy.get().click()</code></li><li>confirm that the API finished with success, <code>cy.intercept()</code> and <code>cy.wait()</code></li><li>the API will send and email to our mailhog local server, included a environment variable use <a href=https://nodemailer.com>nodemailer</a> to send the messages to the test server instead of <a href=https://www.mailgun.com>mailgun</a></li><li>get email received to the created user, call GET <code>/api/v1/messages</code> then <code>/api/v1/messages/{id}</code></li><li>find the confirmation link in the email, decode from <code>quotedPrintable</code> then parse the HTML using <a href=https://cheerio.js.org>cherio</a></li><li>visit the link, <code>cy.visit()</code></li><li>login with the new account</li></ul><h2 id=show-me-the-code>Show me the code</h2><p>Docker compose for the the email</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  email:
    container_name: email
    image: mailhog/mailhog:v1.0.1    
    ports:
      - 1025:1025
      - 8025:8025
    logging:
      driver: &#34;json-file&#34;
      options:
        max-size: &#34;200k&#34;
        max-file: &#34;10&#34;
</code></pre></div><p>Delete all the emails</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>cy.task(&#39;deleteAllEmails&#39;, email).then(response =&gt; {
  cy.log(`All emails deleted from the mail box ${response}`);
})

// code in the plugin
...
const deleteAllEmails = async () =&gt; {
  const { data } = await axios.delete(`${MAILHOG_HOST}/api/v1/messages`);
  return data;
}
</code></pre></div><p>Visiting the signup page</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  beforeEach(() =&gt; {
    cy.visit(`${host}/signup/newuser`);
  })
</code></pre></div><p>Generating fake data and entering in the fields, remember to add the <code>id</code> to the input fields, there is always to option to use the <a href=https://docs.cypress.io/guides/references/best-practices#Selecting-Elements>recommended cypress strategy</a>, <code>cy.get('[data-cy=submit]').click()</code> but I prefer the syntax using the id <code>cy.get('#submit]').click()</code> as most of the time with the new frameworks we pretty much don&rsquo;t change component id, then this field is less volatile, and the syntax seems more readable.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  let email;
  let password;
  let firstName;
  let lastName;

  before(() =&gt; {
    password = faker.internet.password();
    firstName = faker.name.findName();
    lastName = faker.name.findName();
    email = faker.internet.email(firstName, lastName, &#39;host.docker.internal&#39;);
  })

... 
    cy.get(&#39;#firstName&#39;).type(firstName);
    cy.get(&#39;#lastName&#39;).type(lastName);
    cy.get(&#39;#email&#39;).type(email);
    cy.get(&#39;#password&#39;).type(password);
</code></pre></div><p>Submit the form and check if the API finished without problems</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>    cy.intercept(&#39;POST&#39;, &#39;**/user/create*&#39;).as(&#39;CREATE&#39;)
    cy.get(&#39;#submit&#39;).click();
    cy.wait(&#39;@CREATE&#39;).its(&#39;response.statusCode&#39;).should(&#39;be.oneOf&#39;, [201])
</code></pre></div><p>Nodemailer sending email to local server WITHOUT authentication, note that it uses the same data structure as mailgun</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  async sendEmail(data: MailgunData): Promise&lt;string&gt; {
    try {
      this.logger.log(`Send email local ${data.subject} TO: ${data.to}`);

      const transporter = nodemailer.createTransport({
        port: 1025,
        host: &#39;host.docker.internal&#39;,
        secure: false,
      });

      const result = await transporter.sendMail(data);
      this.logger.log(`Email sent ${JSON.stringify(result)}`);
 
      return result;
    } catch (error) {
      this.logger.error(&#39;Error when sending the notification&#39;, error);
    }
  }
...
export class MailgunData {
  subject: string;
  from: string;
  to: string;
  text: string;
  html: string;
}  
</code></pre></div><p>Getting the email messages</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  const { data } = await axios.get(`${MAILHOG_HOST}/api/v1/messages`);
  ...
  // do some data massage to get the email ID, see the plugin full code at the end of this.
  ... 
  const { data } = await axios.get(`${MAILHOG_HOST}/api/v1/messages/${id}`);
  result = data;
</code></pre></div><p>DECODE the <a href=https://www.npmjs.com/package/quoted-printable>quotedPrintable</a> then parse the HTML using <a href=https://cheerio.js.org>cherio</a>, OMG this one took some time, read some more here <a href=https://en.wikipedia.org/wiki/Quoted-printable>Quoted Printable</a>, in summary if you see <code>=3D</code> all over the HTML message there is a good chance you need to decode it :)</p><p>After the decoding there was the challenge of parsing the message HTML, cypress offers this but not in the plugin code, so then I used <a href=https://cheerio.js.org>cherio</a>, my new friend, to parse the HTML, this is such a nicely done piece of technology, simple and very resourcefull. it works just as expected, feed in the HTML, get a parsed object, do queries to find elements, receive a LIST get the one you want and boom retrieve some attributes.</p><p>See the code, it speaks for it self</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>const getLinkFromEmail = (email, tag) =&gt; {
  console.log(`getLinkFromEmail ${email} ${tag}`);
  const body = utf8.decode(quotedPrintable.decode(email.Content.Body));
  const html = cheerio.load(body);
  const links = html(tag).find(&#39;a&#39;);
  const link = links[0];
  const result = link.attribs.href;
  return result;
}
</code></pre></div><p>BONUS - create a plugin for cypress</p><p>Add this to your <code>plugins/index.js</code></p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>/// &lt;reference types=&#34;cypress&#34; /&gt;
const mailHogAPI = require(&#39;./mail-hog.api&#39;)

/**
 * @type {Cypress.PluginConfig}
 */
module.exports = (on, config) =&gt; {
  on(&#34;task&#34;, {
    async &#34;getEmail&#34;(to) {
      return await mailHogAPI.getEmail(to);
    },
    async &#34;deleteAllEmails&#34;() {
      return await mailHogAPI.deleteAllEmails();
    },
    async &#34;getLinkFromEmail&#34;({ email, tag }) {
      return mailHogAPI.getLinkFromEmail(email, tag);
    }
  })
};
</code></pre></div><p>And the plugin file itself <code>plugins/mail-hog.api.js</code></p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>const axios = require(&#34;axios&#34;);
const cheerio = require(&#39;cheerio&#39;);
var quotedPrintable = require(&#39;quoted-printable&#39;);
var utf8 = require(&#39;utf8&#39;);

const MAILHOG_HOST = process.env.MAILHOG_HOST || &#39;http://host.docker.internal:8025&#39;;
// See API documentation here https://github.com/mailhog/MailHog/blob/master/docs/APIv1.md

const getEmail = async (to) =&gt; {
  if (!to) {
    return;
  } else {
    to = to.toLowerCase();
  }

  const { data } = await axios.get(`${MAILHOG_HOST}/api/v1/messages`);

  let id = null;
  let result = null;

  // search path []{ID,Raw:[{To:[string]}]}
  if (data) {
    for (let message of data) {
      if (message.Raw &amp;&amp; message.Raw.To) {
        if (message.Raw.To.includes(to)) {
          id = message.ID;
          break;
        }
      }
    }
  }

  if (id) {
    const { data } = await axios.get(`${MAILHOG_HOST}/api/v1/messages/${id}`);
    result = data;
  }
  return result;
};

// tagSelector, see https://cheerio.js.org/
const getLinkFromEmail = (email, tag) =&gt; {
  console.log(`getLinkFromEmail ${email} ${tag}`);
  const body = utf8.decode(quotedPrintable.decode(email.Content.Body));
  const html = cheerio.load(body);
  const links = html(tag).find(&#39;a&#39;);
  const link = links[0];
  const result = link.attribs.href;
  return result;
}

const deleteAllEmails = async () =&gt; {
  const { data } = await axios.delete(`${MAILHOG_HOST}/api/v1/messages`);
  return data;
}

module.exports = { getEmail, deleteAllEmails, getLinkFromEmail };
</code></pre></div><p>Now you can use it like this in your test code</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>    cy.task(&#39;getEmail&#39;, email).then(response =&gt; {
      expect(response).to.exist;
      cy.log(`Email found ${response.ID}`);

      cy.task(&#39;getLinkFromEmail&#39;, { email: response, tag: &#39;#button&#39; }).then(url =&gt; {
        cy.log(&#39;Account confirmation URL&#39;, url);
        cy.visit(url);
      })
    });
</code></pre></div><p>Enjoy!</p><p><img src=/images/2022/hog.png alt=hog></p></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-twitter"><a href=https://twitter.com/athanazio title=twitter target=_blank rel=noopener><img src=/images/icons/twitter.svg width=24 height=24 alt=twitter></a></span>
<span class="social-icon social-icon-github"><a href=https://github.com/hamilton-lima title=github target=_blank rel=noopener><img src=/images/icons/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/hamiltonlima title=linkedin target=_blank rel=noopener><img src=/images/icons/linkedin.svg width=24 height=24 alt=linkedin></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.df8701b5f509374aa1fd6b7f39e6100d9eedbb268d023d3bec1a6e8220fd6dee.js></script></body></html>