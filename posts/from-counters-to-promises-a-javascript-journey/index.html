<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>From counters to promises a javascript journey - Hamilton Lima</title>
<meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://hamiltonlima.com/favicon.png><link rel=canonical href=https://hamiltonlima.com/posts/from-counters-to-promises-a-javascript-journey/><link rel=stylesheet href=/css/style.min.341d362bef2b6b1437e0cefb99a0cb7e4141b6954f8398c1b10275f699edc362.css><link rel=stylesheet href=/assets/css/extended.min.9729f28a5087b689b946e103d96abd63bfd37b1417effa251dbf798312e3fba5.css><meta property="og:title" content="From counters to promises a javascript journey"><meta property="og:type" content="website"><meta property="og:url" content="https://hamiltonlima.com/posts/from-counters-to-promises-a-javascript-journey/"><meta name=twitter:card content="summary"><meta name=twitter:site content="@athanazio"><meta name=twitter:creator content="@athanazio"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&amp;display=swap" rel=stylesheet></head><body class='page frame page-blog-single'><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-posts><a href=https://hamiltonlima.com/posts>Posts</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>Hamilton Lima</a><div class=menu-main><ul><li class=menu-item-posts><a href=/posts><span>Posts</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>From counters to promises a javascript journey<span class=dot>.</span></h1></div><div class=content><blockquote><p>Beauty always promises, but never gives anything. <a href=https://en.wikipedia.org/wiki/Simone_Weil>Simone Weil</a></p></blockquote><p>Unlike beauty, javascript promises are faithful, and will be fulfilled&mldr; unless someone rejects it :) If you ever need to load images using javascript or did anything that needs to wait until something is done, you probably used a promise, maybe even without noticing. I see Promises as a nice way to simplify the <a href=http://callbackhell.com>callback hell</a>, but don&rsquo;t be fooled, the callbacks are still there, they are only organized in a more simpler way. Let´s take a look at a simple example that loads one image. consider that &ldquo;foo&rdquo; variable is a canvas where we draw something in memory and we want to show that as an image.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>var</span> <span class=n>promise</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Promise</span><span class=p>(</span><span class=n>function</span><span class=p>(</span><span class=n>resolve</span><span class=p>,</span> <span class=n>reject</span><span class=p>)</span> <span class=p>{</span>   
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=n>image</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>Image</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=o>.</span><span class=n>onload</span> <span class=o>=</span> <span class=n>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>resolve</span><span class=p>(</span><span class=n>image</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=o>.</span><span class=n>src</span> <span class=o>=</span> <span class=n>foo</span><span class=o>.</span><span class=n>toDataURL</span><span class=p>(</span><span class=s2>&#34;image/png&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>promise</span><span class=o>.</span><span class=n>then</span><span class=p>(</span><span class=n>function</span><span class=p>(</span><span class=n>data</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>myGreatImage</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>The code above says: &ldquo;When I&rsquo;m done loading the image you can have it&rdquo;. the resolve function from the promise is calling the then implementation, don&rsquo;t tell anybody but there is a callback here&mldr; :) but with a nice name and a very readable structure.</p><h2 id=promises-on-robolucha-masks>Promises on robolucha masks</h2><p>During this weekend I finally add promises to the mask implementation of robolucha. The original implementation was handling image loading by counting the number of images loaded and with a ready method, but after the image loading the tint of the images and the mask building itself wasn&rsquo;t controlling the asynchronous nature of the operation, as a result of it, in Chrome it was working but at Firefox wasn&rsquo;t. The table below describes the features from the robolucha mask builder and the asynchronous challenges from each one.</p><table><thead><tr><th>Feature</th><th>Implementation</th><th>Challenge</th></tr></thead><tbody><tr><td>Base image loading</td><td>Add onload to each image and control the number of images loaded to track if the set of images are ready to be used</td><td>Wait for all the images to load</td></tr><tr><td>Mask building</td><td>Draw tinted images on a canvas and return the base64 image data as src of the resulting image</td><td>Wait for all layers to tint and after it wait for the mask to draw</td></tr><tr><td>Tint an image layer</td><td>Paint the black layer pixels with the chosen color</td><td>Wait for the layer to tint</td></tr></tbody></table><p>The great challenge was at the mask building where the code needed to wait for several promises to resolve and after that return a promise, so this is the implementation of the mask build.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>this</span><span class=o>.</span><span class=n>build</span> <span class=o>=</span> <span class=n>function</span><span class=p>(</span><span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>imagePromises</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>Array</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=k>var</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>data</span><span class=o>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=k>var</span> <span class=n>layer</span> <span class=o>=</span> <span class=n>this</span><span class=o>.</span><span class=n>layers</span>\<span class=p>[</span><span class=n>data</span>\<span class=p>[</span><span class=n>i</span>\<span class=p>]</span><span class=o>.</span><span class=n>name</span>\<span class=p>];</span> 
</span></span><span class=line><span class=cl>	    <span class=k>if</span> <span class=p>(</span><span class=n>layer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>var</span> <span class=n>rgb</span> <span class=o>=</span> <span class=n>this</span><span class=o>.</span><span class=n>hexToRgb</span><span class=p>(</span><span class=n>data</span>\<span class=p>[</span><span class=n>i</span>\<span class=p>]</span><span class=o>.</span><span class=n>color</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>imagePromises</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>this</span><span class=o>.</span><span class=n>tint</span><span class=p>(</span><span class=n>this</span><span class=o>.</span><span class=n>findImageByName</span><span class=p>(</span><span class=n>data</span>\<span class=p>[</span><span class=n>i</span>\<span class=p>]</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>data</span>\<span class=p>[</span><span class=n>i</span>\<span class=p>]</span><span class=o>.</span><span class=n>element</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                     <span class=n>rgb</span><span class=o>.</span><span class=n>red</span><span class=p>,</span> <span class=n>rgb</span><span class=o>.</span><span class=n>green</span><span class=p>,</span><span class=n>rgb</span><span class=o>.</span><span class=n>blue</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	    <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>resultPromise</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Promise</span><span class=p>(</span><span class=n>function</span><span class=p>(</span><span class=n>resolve</span><span class=p>,</span> <span class=n>reject</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=n>Promise</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=n>imagePromises</span><span class=p>)</span><span class=o>.</span><span class=n>then</span><span class=p>(</span><span class=n>function</span><span class=p>(</span><span class=n>images</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>var</span> <span class=n>resultCanvas</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>createElement</span><span class=p>(</span><span class=s2>&#34;canvas&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>resultCanvas</span><span class=o>.</span><span class=n>width</span> <span class=o>=</span> <span class=n>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>resultCanvas</span><span class=o>.</span><span class=n>height</span> <span class=o>=</span> <span class=n>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>var</span> <span class=n>ctx</span> <span class=o>=</span> <span class=n>resultCanvas</span><span class=o>.</span><span class=n>getContext</span><span class=p>(</span><span class=s1>&#39;2d&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>ctx</span><span class=o>.</span><span class=n>imageSmoothingEnabled</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=k>var</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>data</span><span class=o>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		    <span class=n>ctx</span><span class=o>.</span><span class=n>drawImage</span><span class=p>(</span><span class=n>images</span>\<span class=p>[</span><span class=n>i</span>\<span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=k>return</span> <span class=n>the</span> <span class=n>base64</span> <span class=n>string</span> <span class=n>of</span> <span class=n>the</span> <span class=n>image</span>
</span></span><span class=line><span class=cl>		<span class=n>resolve</span><span class=p>(</span><span class=n>resultCanvas</span><span class=o>.</span><span class=n>toDataURL</span><span class=p>(</span><span class=s2>&#34;image/png&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	    <span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=p>});</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>resultPromise</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>Let&rsquo;s talk about some important steps on this code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>imagePromises.push(this.tint(...
</span></span></code></pre></div><p>The &ldquo;tint&rdquo; function returns a promise that will be resolved when the image painting is done. We add to the list of promises that we are waiting for.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>var</span> <span class=n>resultPromise</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Promise</span><span class=p>(</span><span class=n>function</span><span class=p>(</span><span class=n>resolve</span><span class=p>,</span> <span class=n>reject</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=n>Promise</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=n>imagePromises</span><span class=p>)</span><span class=o>.</span><span class=n>then</span><span class=p>(</span><span class=n>function</span><span class=p>(</span><span class=n>images</span><span class=p>)</span> <span class=p>{</span><span class=o>...</span>
</span></span></code></pre></div><p>The &ldquo;Promise.all&rdquo; function allow us to wait for a list of promises and do something at the &ldquo;then&rdquo; function, however, the parameter received at the function is the list of data each promise sends from &ldquo;resolve&rdquo; function. <img src=/images/2017/02/promises-image-to-promisse.all_.jpg alt> With &ldquo;Promise.all&rdquo; I was able to solve one problem that was wait for several other promises, but now I had another one how to transform the result list in one result that should be a &ldquo;promise&rdquo; result? The solution I found was to create a new promise with &ldquo;Promise.all&rdquo; inside so the resolve function would be available.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>resolve(resultCanvas.toDataURL(&#34;image/png&#34;));
</span></span></code></pre></div><p>This resolve function is from the new promise, so when the &ldquo;then&rdquo; implementation of the &ldquo;Promise.all&rdquo; finished it will resolve this new promise sending the image as base64. If you know any other way around this, please let me know :)</p></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-twitter"><a href=https://twitter.com/athanazio title=twitter target=_blank rel=noopener><img src=/images/icons/twitter.svg width=24 height=24 alt=twitter>
</a></span><span class="social-icon social-icon-github"><a href=https://github.com/hamilton-lima title=github target=_blank rel=noopener><img src=/images/icons/github.svg width=24 height=24 alt=github>
</a></span><span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/hamiltonlima title=linkedin target=_blank rel=noopener><img src=/images/icons/linkedin.svg width=24 height=24 alt=linkedin></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.5993fcb11c07dea925a3fbd58c03c7f1857197c35fccce3aa963a12c0b3c9960.js></script></body></html>